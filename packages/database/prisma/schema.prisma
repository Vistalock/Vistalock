generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN // Deprecated, migrate to specific roles
  SUPER_ADMIN // Root Authority
  OPS_ADMIN // Operations
  RISK_ADMIN // Risk & Credit
  COMPLIANCE_ADMIN // Legal & Compliance
  FINANCE_ADMIN // Finance & Treasury
  TECH_ADMIN // Technical / Platform
  SUPPORT_ADMIN // Customer Support
  MERCHANT
  MERCHANT_AGENT // New: For sub-accounts
  LOAN_PARTNER // New: For Loan Partner Users
  CUSTOMER
}

enum LoanPartnerRole {
  ADMIN
  ANALYST
  RISK_OFFICER // Phase 2
  COLLECTIONS_MANAGER // Phase 2
  FINANCE_OFFICER // Phase 2
}

enum SubscriptionPlan {
  STARTER
  GROWTH
  ENTERPRISE
}

enum KycStatus {
  PENDING
  VERIFIED
  FAILED
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String?
  role     Role    @default(CUSTOMER)
  isActive Boolean @default(true)

  apiKey           String?          @unique
  subscriptionPlan SubscriptionPlan @default(STARTER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  loans           Loan[]
  merchantLoans   Loan[]           @relation("MerchantLoans")
  devices         Device[]
  products        Product[]
  transactions    Transaction[]
  customerProfile CustomerProfile?
  merchantProfile MerchantProfile?
  agentProfile    AgentProfile?

  // Agent Relation
  merchantId String?
  merchant   User?   @relation("MerchantAgents", fields: [merchantId], references: [id])
  agents     User[]  @relation("MerchantAgents")

  // Merchant's Loan Partners
  merchantLoanPartners LoanPartner[] @relation("MerchantLoanPartners")

  // Loan Partner User Profile
  loanPartnerProfile LoanPartnerUser?

  // Disputes Raised
  disputes Dispute[] @relation("MerchantDisputes")

  // Audit
  auditLogs      AuditLog[]
  agentLoginLogs AgentLoginLog[]

  // Refresh Tokens
  refreshTokens RefreshToken[]

  // Billing & Wallet (NEW)
  wallet               MerchantWallet?
  enrollmentBillings   EnrollmentBilling[]
  walletTransactions   WalletTransaction[]   @relation("MerchantWalletTransactions")
  featureSubscriptions FeatureSubscription[]
  featureRequests      FeatureRequest[]
}

model AgentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  fullName        String
  phoneNumber     String
  branch          String
  onboardingLimit Int         @default(0)
  status          AgentStatus @default(PENDING)

  // Security & Activation
  activationToken     String?   @unique
  activationExpiresAt DateTime?
  deviceId            String? // Bound Mobile Device ID (IMEI/AndroidID)
  isActivated         Boolean   @default(false)
  lastLoginAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AgentStatus {
  PENDING
  ACTIVE
  DEACTIVATED
}

model AgentLoginLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  deviceId   String?
  ipAddress  String?
  success    Boolean
  failReason String? // e.g., "Invalid password", "Device mismatch", "Account deactivated"

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  entityId   String?
  entityType String?
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
}

model SystemConfig {
  id                 String  @id @default(uuid())
  defaultGracePeriod Int     @default(3)
  currency           String  @default("NGN")
  strictMode         Boolean @default(true)
  offlineLocking     Boolean @default(true)
  emergencyPause     Boolean @default(false)
  supportEmail       String  @default("support@vistalock.com")
  emergencyPhone     String  @default("+234 800 VISTA")

  // Enforcement Rules
  lockEscalationStages Json    @default("[\"REMINDER\", \"SOFT_LOCK\", \"FULL_LOCK\"]")
  lockRetryFrequency   Int     @default(24) // Hours
  offlineLockTimeout   Int     @default(168) // Hours (7 days)
  autoUnlockOnPayment  Boolean @default(true)

  // Device Control
  supportedDeviceTypes Json   @default("[\"ANDROID\"]")
  minAgentVersion      String @default("1.0.0")

  // Risk & Credit
  defaultInterestRate Decimal @default(0.0)
  defaultMaxTenure    Int     @default(12)

  // Compliance
  complianceConfig Json? // Templates, retention policies

  updatedAt DateTime @updatedAt
}

enum ApplicationStatus {
  PENDING
  OPS_REVIEWED
  RISK_REVIEWED
  APPROVED
  REJECTED
}

model MerchantApplication {
  id String @id @default(uuid())

  // 1. Business Info
  businessName        String // Legal Name
  tradingName         String?
  businessType        String? // Sole Prop, LLC, etc.
  cacNumber           String?   @unique // NEW: Unique constraint
  dateOfIncorporation DateTime?
  natureOfBusiness    String?
  website             String?

  // 2. Contact & Address
  contactName      String
  email            String  @unique // NEW: Unique constraint
  phone            String  @unique // NEW: Unique constraint
  businessAddress  String // Registered
  operatingAddress String?

  state            String?
  lga              String?
  yearsInOperation Int?

  // 3-9. Complex Data (Stored as JSON for flexibility during application)
  directors   Json? // [{ name, dob, nationality, address, idType, idNumber, share }]
  signatories Json? // [{ name, role, contact, idNumber }]
  bankDetails Json? // { bankName, accountName, accountNumber, bvn, settlementCycle }

  // New JSON Fields for Detailed Sections
  branches           Json? // [{ name, address, managerName, managerPhone, hours }]
  productDeclaration Json? // { categories: [], brand: [], minPrice, maxPrice, monthlyVolume, condition }

  // Legacy / Other
  operations    Json? // { yearsInOp, outlets, monthlyVolume, avgPrice, salesChannels }
  deviceDetails Json? // { types, specs, source, support }
  agentDetails  Json? // { expectedCount, location, onboardingMethod }

  documents  Json? // URL links to uploaded files { certificate, cacStatus, utilityBill, ids, etc }
  compliance Json? // { agreedToDataProcessing, agreedToLocking, etc }
  reviews    Json? // Audit trail: [{ stage, adminId, timestamp, passed, notes, checklist }]

  status ApplicationStatus @default(PENDING)

  processedBy     String? // Last Admin ID who touched this
  rejectionReason String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
}

model CustomerProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  phoneNumber String  @unique
  bvn         String? @unique
  nin         String? @unique

  firstName   String?
  lastName    String?
  dateOfBirth DateTime?
  address     String?
  photoUrl    String?

  kycStatus   KycStatus @default(PENDING)
  creditScore Int?      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OtpRequest {
  id          String   @id @default(uuid())
  phoneNumber String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
}

enum DeviceStatus {
  LOCKED
  UNLOCKED
  PENDING_SETUP
}

model Device {
  id           String       @id @default(uuid())
  imei         String       @unique
  serialNumber String?
  model        String?
  status       DeviceStatus @default(PENDING_SETUP)

  merchantId String
  merchant   User   @relation(fields: [merchantId], references: [id])
  loans      Loan[]

  lastHeartbeat DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  lockEvents        LockEvent[]
  enrollmentBilling EnrollmentBilling?
}

enum TransactionType {
  PAYMENT
  DISBURSEMENT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum MerchantStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BusinessType {
  SOLE_PROPRIETORSHIP
  LIMITED_LIABILITY
  ENTERPRISE
}

model MerchantProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Business Info
  businessName        String
  businessType        BusinessType
  rcNumber            String       @unique // Registration Number
  dateOfIncorporation DateTime?
  businessAddress     String
  operatingAddress    String?

  // Director KYC
  directorName  String
  directorPhone String
  directorNin   String? // National Identity Number

  // Financial Info
  bankName      String?
  accountNumber String?
  accountName   String?
  revenueShare  Decimal @default(0.0) // Percentage

  // Compliance
  documents        Json? // { cacAttributes, directorId, merchantAgreement }
  agreementsSigned Boolean @default(false)

  status MerchantStatus @default(PENDING)

  // Package / Limits
  maxDevices         Int   @default(10)
  maxAgents          Int   @default(2)
  enabledDeviceTypes Json? @default("[\"ANDROID\"]")

  // WHITE-LABEL BRANDING (NEW)
  companyName    String? // Display name (can differ from businessName)
  logoUrl        String? // Company logo URL
  faviconUrl     String? // Browser favicon URL
  primaryColor   String? @default("#4F46E5") // Brand primary color
  secondaryColor String? @default("#10B981") // Brand secondary color
  accentColor    String? @default("#F59E0B") // Brand accent color

  // CUSTOM DOMAIN (PREMIUM FEATURE)
  customDomain   String? @unique // e.g. portal.merchantname.com
  domainVerified Boolean @default(false)
  sslEnabled     Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
}

model Transaction {
  id        String            @id @default(uuid())
  amount    Decimal
  currency  String            @default("NGN")
  type      TransactionType
  status    TransactionStatus @default(PENDING)
  reference String            @unique // Paystack Ref

  loanId String
  loan   Loan   @relation(fields: [loanId], references: [id])

  merchantId String
  merchant   User   @relation(fields: [merchantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id String @id @default(uuid())

  name        String
  description String?
  sku         String?

  // Pricing
  price    Decimal @default(0.0)
  currency String  @default("NGN")

  // BNPL Terms (Product Specific Defaults)
  minDownPayment Decimal @default(0.0)
  minTenure      Int     @default(3) // Months
  maxTenure      Int     @default(12) // Months
  interestRate   Decimal @default(2.5) // Monthly Interest %

  // Inventory
  stockQuantity Int     @default(0)
  category      String? // PHONE, LAPTOP, etc.

  itemType String? @default("PHYSICAL") // PHYSICAL, DIGITAL, SERVICE

  merchantId String
  merchant   User   @relation(fields: [merchantId], references: [id])

  // FINANCING MODE (NEW)
  financingMode String? @default("SELF") // SELF (merchant self-finances), LOAN_PARTNER

  // Platform Pivot: Product is financed by a specific Loan Partner (optional)
  loanPartnerId String?
  loanPartner   LoanPartner? @relation(fields: [loanPartnerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Loan      Loan[]
}

// ==================== CREDIT SERVICE MODELS ====================

// ==================== CREDIT SERVICE MODELS ====================

model CreditCheck {
  id      String @id @default(uuid())
  checkId String @unique

  merchantId     String
  agentId        String
  phoneNumber    String
  nin            String
  bvn            String?
  requestedPrice Float

  decision       String
  score          Int
  maxDeviceValue Float?
  minDownPayment Float?
  allowedTenure  String?
  interestRate   Float?
  creditRating   String?

  reasonCode    String?
  reasonMessage String?

  fraudDetected Boolean @default(false)
  fraudReasons  String?
  riskScore     Int?

  createdAt DateTime @default(now())

  @@index([merchantId])
  @@index([agentId])
  @@index([phoneNumber])
  @@index([nin])
  @@index([createdAt])
}

model Blacklist {
  id String @id @default(uuid())

  nin         String?
  bvn         String?
  phoneNumber String?

  reason    String
  addedBy   String?
  addedAt   DateTime  @default(now())
  expiresAt DateTime?

  isActive Boolean @default(true)

  @@index([nin])
  @@index([bvn])
  @@index([phoneNumber])
  @@index([isActive])
}

// ==================== ENHANCED LOAN MODELS (Production-Grade) ====================

enum LoanStatus {
  PENDING
  ACTIVE
  COMPLETED
  DEFAULTED
  LOCKED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  LATE
  MISSED
  PARTIAL
}

model Loan {
  id String @id @default(uuid())

  // Customer Information
  userId        String
  user          User    @relation(fields: [userId], references: [id])
  customerNIN   String // For quick lookup
  customerBVN   String?
  customerPhone String

  // Device Information
  deviceIMEI String
  device     Device  @relation(fields: [deviceIMEI], references: [imei])
  productId  String
  product    Product @relation(fields: [productId], references: [id])

  // Merchant/Agent
  merchantId String
  merchant   User    @relation("MerchantLoans", fields: [merchantId], references: [id])
  agentId    String?

  // Platform Pivot: The Lender
  loanPartnerId String?
  loanPartner   LoanPartner? @relation(fields: [loanPartnerId], references: [id])

  // Loan Terms
  loanAmount       Float
  downPayment      Float
  monthlyRepayment Float
  tenure           Int // Months
  interestRate     Float // Monthly rate
  totalRepayment   Float

  // Status
  status LoanStatus @default(PENDING)

  // Repayment Tracking
  paymentsOnTime    Int   @default(0)
  paymentsLate      Int   @default(0)
  paymentsMissed    Int   @default(0)
  totalPayments     Int   @default(0)
  paidAmount        Float @default(0)
  outstandingAmount Float

  // Payment Schedule
  nextPaymentDue  DateTime?
  lastPaymentDate DateTime?

  // Lock History
  lockCount      Int       @default(0)
  isLocked       Boolean   @default(false)
  lastLockedAt   DateTime?
  lastUnlockedAt DateTime?

  // Credit Check Reference
  creditCheckId String?
  creditScore   Int?

  // Timestamps
  approvedAt  DateTime?
  completedAt DateTime?
  defaultedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  payments     Payment[]
  transactions Transaction[]
  Dispute      Dispute[]

  @@index([userId])
  @@index([customerNIN])
  @@index([customerBVN])
  @@index([customerPhone])
  @@index([deviceIMEI])
  @@index([merchantId])
  @@index([status])
  @@index([nextPaymentDue])
}

model Payment {
  id String @id @default(uuid())

  loanId String
  loan   Loan   @relation(fields: [loanId], references: [id])

  // Payment Details
  amount     Float
  dueDate    DateTime
  paidDate   DateTime?
  paidAmount Float?

  // Status
  status   PaymentStatus @default(PENDING)
  daysLate Int           @default(0)

  // Payment Method
  paymentMethod String? // BANK_TRANSFER, CARD, CASH, etc.
  reference     String? // Payment reference

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Dispute   Dispute[]

  @@index([loanId])
  @@index([status])
  @@index([dueDate])
}

// ==================== PLATFORM PIVOT MODELS (PHASE 5) ====================

model LoanPartner {
  id String @id @default(uuid())

  name        String
  slug        String // e.g. 'fincra', 'fairmoney' - NOT globally unique anymore
  description String?
  logoUrl     String?

  // MERCHANT-SCOPED (NEW) - Made optional for migration compatibility
  merchantId String? // Optional to allow existing data migration
  merchant   User?   @relation("MerchantLoanPartners", fields: [merchantId], references: [id], onDelete: Cascade)

  // API Integration Config (for external loan partner API)
  apiKey        String? @unique // For loan partner to authenticate
  apiSecret     String? // Encrypted - for loan partner to authenticate
  webhookUrl    String? // Loan partner's webhook URL
  webhookSecret String? // For verifying webhooks FROM loan partner

  // Contact Information
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Configuration
  isActive                Boolean @default(true) // Preserve existing production field
  status                  String  @default("ACTIVE") // ACTIVE, INACTIVE
  supportedRepaymentTypes Json? // ["DAILY", "WEEKLY", "MONTHLY"]
  maxTenure               Int     @default(12)
  minDownPaymentPct       Decimal @default(30.0)

  // System
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  // Relations
  loans       Loan[]
  products    Product[]
  webhookLogs WebhookLog[]
  users       LoanPartnerUser[] // Relation to users managing this partner
  
  // Phase 2 Relations
  riskConfig  RiskConfig?
  wallet      LoanPartnerWallet?

  @@unique([merchantId, slug]) // Slug unique per merchant
  @@index([merchantId])
  @@index([status])
}

model LoanPartnerUser {
  id            String          @id @default(uuid())
  userId        String          @unique
  user          User            @relation(fields: [userId], references: [id])
  
  loanPartnerId String
  loanPartner   LoanPartner     @relation(fields: [loanPartnerId], references: [id])
  
  role          LoanPartnerRole @default(ANALYST)
  isActive      Boolean         @default(true)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([loanPartnerId])
  @@index([userId])
}

model RiskConfig {
  id            String      @id @default(uuid())
  loanPartnerId String      @unique
  loanPartner   LoanPartner @relation(fields: [loanPartnerId], references: [id])

  // Limits
  maxTicketSize Decimal     @default(500000) @db.Decimal(12, 2)
  minTicketSize Decimal     @default(10000) @db.Decimal(12, 2)
  maxTenor      Int         @default(6) // Months
  
  // Rules
  minCreditScore Int        @default(600)
  autoApprove    Boolean    @default(false)
  autoReject     Boolean    @default(true)
  
  // Interest
  interestRate  Decimal     @default(5.0) @db.Decimal(5, 2) // Monthly query

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model LoanPartnerWallet {
  id            String      @id @default(uuid())
  loanPartnerId String      @unique
  loanPartner   LoanPartner @relation(fields: [loanPartnerId], references: [id])

  balance       Decimal     @default(0) @db.Decimal(15, 2)
  ledgerBalance Decimal     @default(0) @db.Decimal(15, 2)
  currency      String      @default("NGN")

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}


enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

model Dispute {
  id String @id @default(uuid())

  // Pivot: Can dispute a Loan or a specific Payment
  loanId    String
  loan      Loan     @relation(fields: [loanId], references: [id])
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  // Context
  merchantId String
  merchant   User   @relation("MerchantDisputes", fields: [merchantId], references: [id])

  // Details
  reason       String
  description  String? @db.Text
  evidenceUrls Json? // Array of URLs

  status     DisputeStatus @default(OPEN)
  resolution String?       @db.Text
  resolvedBy String? // ID of user who resolved it
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loanId])
  @@index([merchantId])
  @@index([status])
}

model LockEvent {
  id String @id @default(uuid())

  deviceImei String
  device     Device @relation(fields: [deviceImei], references: [imei])

  type        String // SOFT_LOCK, HARD_LOCK, UNLOCK
  reason      String?
  triggeredBy String // "SYSTEM", "LOAN_PARTNER_WEBHOOK", "ADMIN_OVERRIDE"

  metadata Json? // Snapshot of loan status or API payload

  createdAt DateTime @default(now())

  @@index([deviceImei])
  @@index([createdAt])
}

model WebhookLog {
  id String @id @default(uuid())

  loanPartnerId String
  loanPartner   LoanPartner @relation(fields: [loanPartnerId], references: [id])

  eventType    String // "PAYMENT_RECEIVED", "DEFAULT", etc
  payload      Json
  responseCode Int
  status       String // "PROCESSED", "FAILED"

  createdAt DateTime @default(now())

  @@index([loanPartnerId])
  @@index([createdAt])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  @@index([userId])
  @@index([token])
}

// ==================== BILLING & WALLET MODELS ====================

model MerchantWallet {
  id         String  @id @default(uuid())
  merchantId String  @unique
  merchant   User    @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  balance    Decimal @default(0) @db.Decimal(15, 2)
  currency   String  @default("NGN")
  status     String  @default("ACTIVE") // ACTIVE, SUSPENDED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]
}

model WalletTransaction {
  id            String         @id @default(uuid())
  walletId      String
  wallet        MerchantWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  merchantId    String
  merchant      User           @relation("MerchantWalletTransactions", fields: [merchantId], references: [id])
  type          String // CREDIT (top-up), DEBIT (enrollment fee, subscription)
  amount        Decimal        @db.Decimal(15, 2)
  balanceBefore Decimal        @db.Decimal(15, 2)
  balanceAfter  Decimal        @db.Decimal(15, 2)
  reference     String? // Payment reference (Paystack, bank transfer, etc.)
  description   String
  metadata      Json? // Additional data

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([merchantId])
  @@index([type])
  @@index([createdAt])
}

model EnrollmentBilling {
  id             String    @id @default(uuid())
  merchantId     String
  merchant       User      @relation(fields: [merchantId], references: [id])
  deviceId       String    @unique
  device         Device    @relation(fields: [deviceId], references: [id])
  amount         Decimal   @db.Decimal(10, 2)
  tier           String // Pricing tier name applied
  volumeAtTime   Int // Monthly enrollment volume when this device was enrolled
  status         String // PENDING, PAID, REVERSED
  paidAt         DateTime?
  reversedAt     DateTime?
  reversalReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
}

model PricingTier {
  id             String  @id @default(uuid())
  name           String
  minVolume      Int // Minimum monthly enrollments
  maxVolume      Int? // Maximum (null = unlimited)
  pricePerDevice Decimal @db.Decimal(10, 2)
  currency       String  @default("NGN")
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([minVolume])
}

// ==================== FEATURE ADD-ON MODELS ====================

model Feature {
  id          String  @id @default(uuid())
  name        String
  description String  @db.Text
  category    String // SECURITY, ANALYTICS, INTEGRATION, SUPPORT
  pricingType String // PER_DEVICE, FLAT_MONTHLY, ONE_TIME
  price       Decimal @db.Decimal(10, 2)
  isActive    Boolean @default(true)
  metadata    Json? // Additional configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions FeatureSubscription[]

  @@index([category])
  @@index([isActive])
}

model FeatureSubscription {
  id          String    @id @default(uuid())
  merchantId  String
  merchant    User      @relation(fields: [merchantId], references: [id])
  featureId   String
  feature     Feature   @relation(fields: [featureId], references: [id])
  status      String    @default("ACTIVE") // ACTIVE, CANCELLED
  startedAt   DateTime  @default(now())
  cancelledAt DateTime?

  @@unique([merchantId, featureId])
  @@index([merchantId])
  @@index([featureId])
  @@index([status])
}

model FeatureRequest {
  id          String   @id @default(uuid())
  merchantId  String
  merchant    User     @relation(fields: [merchantId], references: [id])
  title       String
  description String   @db.Text
  useCase     String?  @db.Text
  budget      Decimal? @db.Decimal(10, 2)
  status      String   @default("PENDING") // PENDING, REVIEWING, QUOTED, APPROVED, REJECTED
  adminNotes  String?  @db.Text
  quotedPrice Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@index([status])
  @@index([createdAt])
}
